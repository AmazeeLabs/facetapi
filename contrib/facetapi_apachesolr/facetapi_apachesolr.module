<?php
// $Id$

/**
 * @file
 * The Apache Solr Search Integration module's implementation of the the Facet
 * API.
 */

/**
 * Implementation of hook_menu().
 */
function facetapi_apachesolr_menu() {
  $items = array();

  $items['admin/settings/apachesolr/facets'] = array(
    'title' => 'Facets',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('facetapi_admin_settings_form', 'apachesolr_search'),
    'access arguments' => array('administer search'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'facetapi.admin.inc',
    'file path' => drupal_get_path('module', 'facetapi'),
    'weight' => 10,
  );

  return $items;
}

/**
 * Implementation of hook_facetapi_adapter_info().
 */
function facetapi_apachesolr_facetapi_adapter_info() {
  return array(
    'apachesolr_search' => array(
      'class' => 'FacetapiApachesolrAdapter',
      'type' => 'node',
      'file' => 'facetapi_apachesolr.adapter.inc',
    ),
  );
}

/**
 * Implementation of hook_facetapi_facet_info_alter().
 *
 * Modifies fields for vocabulary facets.
 */
function facetapi_apachesolr_facetapi_facet_info_alter(array &$facets, $searcher, $type) {
  if ('apachesolr_search' == $searcher) {
    foreach ($facets as &$facet) {
      if (preg_match('/^vocabulary_(\d+)$/', $facet['name'], $matches)) {
        $facet['field'] = 'im_vid_'. $matches[1];;
        $facet['field alias'] = 'tid';
      }
    }
    unset($facet);
  }
}

/**
 * Implementation of hook_apachesolr_prepare_query().
 *
 * Invokes type hooks, adds filters.
 */
function facetapi_apachesolr_apachesolr_prepare_query($query, &$params, $caller) {
  facetapi_query_type_hooks_invoke('apachesolr_search', $params, $query);

  // Gets enabled facets, adds filter queries to $params.
  $adapter = facetapi_adapter_load('apachesolr_search');
  foreach (facetapi_enabled_facets_get('apachesolr_search') as $facet) {
    $queries = array();
    foreach ($adapter->getActiveItems($facet) as $value => $item) {
      $queries[] = $facet['field alias'] .':'. $value;
    }
    if (!empty($queries)) {
      $params['fq'][$facet['field alias']] = $queries;
    }
  }
}

/**
 * Implementation of hook_facetapi_query_TYPE_process().
 */
function facetapi_apachesolr_facetapi_query_term_process(FacetapiAdapter $adapter, array $facet, &$params, $query) {
  $searcher = $adapter->getSearcher();

  // Adds the operator parameter.
  $operator = facetapi_setting_get('operator', $searcher, '', $facet['name']);
  $ex = (FACETAPI_OPERATOR_OR != $operator) ? '' : "{!ex={$facet['field']}}";
  $params['facet.field'][] = $ex . $facet['field'];

  // Adds "hard limit" parameter to prevent too many return values.
  $limit = facetapi_setting_get('hard_limit', $searcher, '', $facet['name']);
  $params['f.'. $facet['field'] .'.facet.limit'] = ($limit !== NULL) ? (int)$limit : 20;
}

/**
 * Implementation of hook_facetapi_query_TYPE_process().
 */
function facetapi_apachesolr_facetapi_query_date_process(FacetapiAdapter $adapter, array $facet, &$params, $query) {
  $searcher = $adapter->getSearcher();

  // Gets the data range in formats that Solr understands.
  list($start, $end, $gap) = facetapi_apachesolr_date_range($query, $facet['field']);

  $params['facet.date'][] = $facet['field'];
  $params['f.'. $facet['field'] .'.facet.date.start'] = $start;
  $params['f.'. $facet['field'] .'.facet.date.end'] = $end;
  $params['f.'. $facet['field'] .'.facet.date.gap'] = $gap;

  // Adds "hard limit" parameter to prevent too many return values.
  $limit = facetapi_setting_get('hard_limit', $searcher, '', $facet['name']);
  $params['f.'. $facet['field'] .'.facet.limit'] = ($limit !== NULL) ? (int)$limit : 20;
}

/**
 * Gets the range of dates we are using.
 *
 * @param $query
 *   A Solr_Base_Query object.
 * @param $facet_field
 *   A string containing the name of the facet field.
 *
 * @return
 *   An array containing the gap and range information.
 *
 * @todo integrate this into facetapi_apachesolr_facetapi_date_range_process()
 *       once we have a "range limit callback".
 */
function facetapi_apachesolr_date_range(Solr_Base_Query $query, $facet_field) {

  // Captures adapter, facet.
  // @todo Do we need some defensive coding here?
  // @todo Is facet field the facet name or the field alias?
  $adapter = facetapi_adapter_load('apachesolr_search');
  $enabled_facets = facetapi_enabled_facets_get('apachesolr_search');
  $facet = $enabled_facets[$facet_field];

  // Attempts to get next gap from passed date filters.
  $return = NULL;
  foreach ($adapter->getActiveItems($facet) as $value => $item) {
    if ($gap = facetapi_date_gap_get($item['start'], $item['end'])) {
      $next_gap = facetapi_next_date_gap_get($gap, FACETAPI_DATE_MINUTE);
      if ($next_gap == $gap) {
        $next_gap = NULL;
      }
      $return = array(
        "{$item['start']}/$next_gap",
        "{$item['end']}+1$next_gap/$next_gap",
        "+1$next_gap",
      );
    }
  }

  // If no filters were passed, get default range.
  if (NULL === $return) {

    // Builds SQL that gets minimum and maximum values from node table.
    $minimum = $maximum = FALSE;
    if (!empty($facet['min callback']) && function_exists($facet['min callback'])) {
      $minimum = $facet['min callback']($facet);
    }
    if (!empty($facet['max callback']) && function_exists($facet['max callback'])) {
      $maximum = $facet['max callback']($facet);
    }

    // Gets the default gap.
    $gap = FACETAPI_DATE_YEAR;
    if ($minimum && $maximum) {
      $gap = facetapi_timestamp_gap_get($minimum, $maximum);
      $minimum = facetapi_isodate($minimum, $gap);
      $maximum = facetapi_isodate($maximum, $gap);
      $return = array(
        "$minimum/$gap",
        "$maximum+1$gap/$gap",
        "+1$gap",
      );
    }
  }

  // Returns the range information.
  return $return;
}

/**
 * Implementation of hook_form_FORM_ID_alter().
 *
 * Adds breadcrumb trail for Apache Solr administrative pages.
 */
function facetapi_apachesolr_form_facetapi_facet_settings_form_alter(&$form, &$form_state) {
  if ('apachesolr_search' == arg(2)) {
    $breadcrumb = drupal_get_breadcrumb();
    $breadcrumb[] = l(t('Apache Solr'), 'admin/settings/apachesolr');
    $breadcrumb[] = l(t('Facets'), 'admin/settings/apachesolr/facets');
    drupal_set_breadcrumb($breadcrumb);
  }
}
